function ImageManipulator(t,e,i){this.settings={canvasId:"",wrapperSelector:"",borderStyle:"none",borderWidth:0,borderStroke:"rgba(255,255,255,0)",borderShade:"rgba(255,255,255,.7)",cropWidth:null,cropHeight:null};for(var s in i)i.hasOwnProperty(s)&&(this.settings[s]=i[s]);var a=2*e.width,h=t.width/t.height;t.width>a&&t.width>t.height?(imgWidth=a,imgHeight=imgWidth/h):t.height>a?(imgHeight=a,imgWidth=imgHeight*h):(imgHeight=t.height,imgWidth=t.width),this.image={file:t.file,URL:t.src,width:imgWidth,height:imgHeight,ratio:h,scale:1},this.coord={x:e.width/2-imgWidth/2,y:e.height/2-imgHeight/2},this.middleCoord={x:this.coord.x+imgWidth/2,y:this.coord.y+imgHeight/2},this.canvas={element:e.element,height:e.height,width:e.width,x:0,y:0,angle:0},this.init()}function UserImage(t){var e=document.querySelector(t.wrapperSelector),i=e.getElementsByTagName("canvas")[0],s={},a={},h=e.querySelector(".files"),r=h.files[0];a.element=i,a.height=i.height,a.width=i.width;var o=/image.*/;if(r.type.match(o)){var n=new FileReader;n.onloadend=function(){var e=new Image;e.src=n.result,e.onload=function(){s.file=e,s.src=e.src,s.width=e.width,s.height=e.height,myEditableImage=new ImageManipulator(s,a,t)}},n.readAsDataURL(r)}else console.log("oops... something when wrong")}window.onload=function(){var t=document.querySelector("#files");t.addEventListener("change",function(){userImage=new UserImage({wrapperSelector:".canvas-wrapper",borderStyle:"square",borderWidth:50,borderStroke:"#29ABE2",borderShade:"rgba(255,255,255,.7)",cropWidth:300,cropHeight:300})})},ImageManipulator.prototype={init:function(){var t=document.querySelector(this.settings.wrapperSelector);console.log(t);var e=this.canvas.element,i=e.getContext("2d");this.canvas.ctx=i,this.canvas.ctx.drawImage(this.image.file,this.coord.x,this.coord.y,this.image.width,this.image.height),this.drawBorder();var s=this;window.addEventListener("mouseup",function(){window.removeEventListener("mousemove",s.boundDrag,!1)});var a=t.querySelector(".rotate-canvas");a.addEventListener("click",function(){s.rotate()});var h=t.querySelector(".save");h.addEventListener("click",function(){s.save(),console.log("saved")}),e.addEventListener("mousedown",function(t){s.dragStart(t)});var r=document.querySelector("#scale");r.addEventListener("input",function(){value=document.querySelector("#scale").value,value/=100,s.scale(value)})},save:function(){var t=document.createElement("canvas"),e=t.getContext("2d"),i=2*this.settings.borderWidth;e.canvas.width=2*(this.canvas.width-i),e.canvas.height=2*(this.canvas.height-i),console.log(i),e.drawImage(this.image.file,2*(this.coord.x-i/2),2*(this.coord.y-i/2),this.image.width*this.image.scale*2,this.image.height*this.image.scale*2);var s=document.querySelector("body");t.style.border="1px solid black",s.appendChild(t)},repaint:function(){var t,e,i=this.image.width*this.image.scale,s=this.image.height*this.image.scale,a=this.canvas.angle;switch(a){case 90:t=this.coord.y,e=-this.coord.x;break;case 180:t=-this.coord.x,e=-this.coord.y;break;case 270:t=-this.coord.y,e=this.coord.x;break;default:t=this.coord.x,e=this.coord.y}this.canvas.ctx.clearRect(this.canvas.x,this.canvas.y,this.canvas.width,this.canvas.height),this.canvas.ctx.drawImage(this.image.file,t,e,i,s),this.drawBorder()},drawBorder:function(){var t=this.settings.borderStyle;"circle"===t?this.circleBorder():"square"===t&&this.squareBorder()},circleBorder:function(){var t=this.canvas.ctx,e=this.settings.borderWidth,i={x:this.canvas.width/2,y:this.canvas.height/2},s=this.canvas.width/2+e,a=this.canvas.width/2-e;t.beginPath(),t.arc(i.x,i.y,s,0,2*Math.PI,!1),t.lineWidth=4*e,t.strokeStyle=this.settings.borderShade,t.stroke(),t.beginPath(),t.arc(i.x,i.y,a,0,2*Math.PI,!1),t.lineWidth=3,t.strokeStyle=this.settings.borderStroke,t.stroke()},squareBorder:function(){var t=this.canvas.ctx,e=this.settings.borderWidth,i=this.canvas.height+2*e,s=this.canvas.width+2*e,a=this.canvas.height-2*e,h=this.canvas.width-2*e;t.beginPath(),t.rect(-e,-e,s,i),t.lineWidth=4*e,t.strokeStyle="rgba(255,255,255,.7)",t.stroke(),t.beginPath(),t.rect(e,e,h,a),t.lineWidth=3,t.strokeStyle=this.settings.borderStroke,t.stroke()},scale:function(t){this.image.scale=t;var e=this.image.width*t,i=this.image.height*t,s=this.middleCoord.x-e/2,a=this.middleCoord.y-i/2;this.coord.x=s,this.coord.y=a,this.repaint()},dragStart:function(t){mousePosition=this.getMousePosition(t),this.difference={x:this.coord.x-mousePosition.x,y:this.coord.y-mousePosition.y},this.boundDrag=this.dragPosition.bind(this),window.addEventListener("mousemove",this.boundDrag,!1)},getMousePosition:function(t){var e=this.canvas.element.getBoundingClientRect(),i={x:t.clientX-e.left,y:t.clientY-e.top};return i},dragPosition:function(t){mousePosition=this.getMousePosition(t),this.coord.x=mousePosition.x+this.difference.x,this.coord.y=mousePosition.y+this.difference.y,this.repaint(),this.middleCoord={x:this.coord.x+this.image.width*this.image.scale/2,y:this.coord.y+this.image.height*this.image.scale/2}},rotate:function(){this.canvas.angle=this.canvas.angle+90;var t=90,e=this.canvas.ctx;90===t?e.translate(this.canvas.width/2+this.canvas.height/2,0):180===t?e.translate(this.canvas.width,this.canvas.height):270===t?e.translate(0,this.canvas.height):e.translate(0,0),e.rotate(t*Math.PI/180),360===this.canvas.angle&&(this.canvas.angle=0),this.repaint()}};