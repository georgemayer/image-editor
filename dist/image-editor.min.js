function ImageManipulator(t,i,e){this.settings={canvasId:"",wrapperSelector:"",borderStyle:"none",borderWidth:0,borderStroke:"rgba(255,255,255,0)",borderShade:"rgba(255,255,255,.7)",cropWidth:null,cropHeight:null};for(var s in e)e.hasOwnProperty(s)&&(this.settings[s]=e[s]);var a=2*i.width,h=t.width/t.height;t.width>a&&t.width>t.height?(imgWidth=a,imgHeight=imgWidth/h):t.height>a?(imgHeight=a,imgWidth=imgHeight*h):(imgHeight=t.height,imgWidth=t.width),this.image={file:t.file,URL:t.src,width:imgWidth,height:imgHeight,ratio:h,scale:1},this.coord={x:i.width/2-imgWidth/2,y:i.height/2-imgHeight/2},this.middleCoord={x:this.coord.x+imgWidth/2,y:this.coord.y+imgHeight/2},this.canvas={element:i.element,height:i.height,width:i.width,x:0,y:0,angle:0},this.init()}function UserImage(t){var i=document.querySelector(t.wrapperSelector),e=i.getElementsByTagName("canvas")[0],s={},a={},h=i.querySelector(".files"),o=h.files[0];a.element=e,a.height=e.height,a.width=e.width;var r=/image.*/;if(o.type.match(r)){var n=new FileReader;n.onloadend=function(){var i=new Image;i.src=n.result,i.onload=function(){s.file=i,s.src=i.src,s.width=i.width,s.height=i.height,myEditableImage=new ImageManipulator(s,a,t)}},n.readAsDataURL(o)}else console.log("oops... something when wrong")}ImageManipulator.prototype={init:function(){var t=document.querySelector(this.settings.wrapperSelector);console.log(t);var i=this.canvas.element,e=i.getContext("2d");this.canvas.ctx=e,this.canvas.ctx.drawImage(this.image.file,this.coord.x,this.coord.y,this.image.width,this.image.height),this.drawBorder();var s=this;window.addEventListener("mouseup",function(){window.removeEventListener("mousemove",s.boundDrag,!1)});var a=t.querySelector(".rotate-canvas");a.addEventListener("click",function(){s.rotate()});var h=t.querySelector(".save");h.addEventListener("click",function(){s.save(),console.log("saved")}),i.addEventListener("mousedown",function(t){s.dragStart(t)});var o=document.querySelector("#scale");o.addEventListener("input",function(){value=document.querySelector("#scale").value,value/=100,s.scale(value)})},save:function(){var t=document.createElement("canvas"),i=t.getContext("2d"),e=2*this.settings.borderWidth;i.canvas.width=2*(this.canvas.width-e),i.canvas.height=2*(this.canvas.height-e),console.log(e),i.drawImage(this.image.file,2*(this.coord.x-e/2),2*(this.coord.y-e/2),this.image.width*this.image.scale*2,this.image.height*this.image.scale*2);var s=document.querySelector("body");t.style.border="1px solid black",s.appendChild(t)},repaint:function(){var t,i,e=this.image.width*this.image.scale,s=this.image.height*this.image.scale,a=this.canvas.angle;switch(a){case 90:t=this.coord.y,i=-this.coord.x;break;case 180:t=-this.coord.x,i=-this.coord.y;break;case 270:t=-this.coord.y,i=this.coord.x;break;default:t=this.coord.x,i=this.coord.y}this.canvas.ctx.clearRect(this.canvas.x,this.canvas.y,this.canvas.width,this.canvas.height),this.canvas.ctx.drawImage(this.image.file,t,i,e,s),this.drawBorder()},drawBorder:function(){var t=this.settings.borderStyle;"circle"===t?this.circleBorder():"square"===t&&this.squareBorder()},circleBorder:function(){var t=this.canvas.ctx,i=this.settings.borderWidth,e={x:this.canvas.width/2,y:this.canvas.height/2},s=this.canvas.width/2+i,a=this.canvas.width/2-i;t.beginPath(),t.arc(e.x,e.y,s,0,2*Math.PI,!1),t.lineWidth=4*i,t.strokeStyle=this.settings.borderShade,t.stroke(),t.beginPath(),t.arc(e.x,e.y,a,0,2*Math.PI,!1),t.lineWidth=3,t.strokeStyle=this.settings.borderStroke,t.stroke()},squareBorder:function(){var t=this.canvas.ctx,i=this.settings.borderWidth,e=this.canvas.height+2*i,s=this.canvas.width+2*i,a=this.canvas.height-2*i,h=this.canvas.width-2*i;t.beginPath(),t.rect(-i,-i,s,e),t.lineWidth=4*i,t.strokeStyle="rgba(255,255,255,.7)",t.stroke(),t.beginPath(),t.rect(i,i,h,a),t.lineWidth=3,t.strokeStyle=this.settings.borderStroke,t.stroke()},scale:function(t){this.image.scale=t;var i=this.image.width*t,e=this.image.height*t,s=this.middleCoord.x-i/2,a=this.middleCoord.y-e/2;this.coord.x=s,this.coord.y=a,this.repaint()},dragStart:function(t){mousePosition=this.getMousePosition(t),this.difference={x:this.coord.x-mousePosition.x,y:this.coord.y-mousePosition.y},this.boundDrag=this.dragPosition.bind(this),window.addEventListener("mousemove",this.boundDrag,!1)},getMousePosition:function(t){var i=this.canvas.element.getBoundingClientRect(),e={x:t.clientX-i.left,y:t.clientY-i.top};return e},dragPosition:function(t){mousePosition=this.getMousePosition(t),this.coord.x=mousePosition.x+this.difference.x,this.coord.y=mousePosition.y+this.difference.y,this.repaint(),this.middleCoord={x:this.coord.x+this.image.width*this.image.scale/2,y:this.coord.y+this.image.height*this.image.scale/2}},rotate:function(){this.canvas.angle=this.canvas.angle+90;var t=90,i=this.canvas.ctx;90===t?i.translate(this.canvas.width/2+this.canvas.height/2,0):180===t?i.translate(this.canvas.width,this.canvas.height):270===t?i.translate(0,this.canvas.height):i.translate(0,0),i.rotate(t*Math.PI/180),360===this.canvas.angle&&(this.canvas.angle=0),this.repaint()}};